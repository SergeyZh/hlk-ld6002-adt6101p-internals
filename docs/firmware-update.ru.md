# Обновление прошивки радаров HLK‑LD6002/ADT6101P (через XMODEM‑CRC)

[![en](https://img.shields.io/badge/lang-en-blue.svg)](firmware-update.md)
[![ru](https://img.shields.io/badge/lang-ru-green.svg)](firmware-update.ru.md)

Данный документ описывает процесс перевода радара в режим загрузчика и загрузку новой прошивки с помощью утилит из каталога `utils/`.

Кратко: запустите `radar-tui.py` и нажмите кнопку «Trigger Firmware update». Радар перейдёт в режим загрузки новой прошивки (bootloader). Затем выйдите из `radar-tui.py` и выполните передачу файла прошивки по протоколу XMODEM‑CRC при помощи `xmodem_send.py`.

## Требования
- Установленный Python 3.7+.
- Зависимости из `utils/requirements.txt`:
  - textual, pyserial, pyserial-asyncio (и др., если будут добавлены)
- Доступ к последовательному порту радара (USB‑UART адаптер и т. п.).
- Файл прошивки (`.bin`). Подготовленные примеры находятся в `utils/`.

Установка зависимостей:

```bash
pip install -r utils/requirements.txt
```

## Шаг 1. Перевести радар в режим обновления прошивки
1. Подключите радар к компьютеру и определите его COM/tty порт.
   - Linux: обычно `/dev/ttyUSB0`, `/dev/ttyACM0`
   - macOS: обычно `/dev/tty.usbserial‑XXXX`, `/dev/tty.usbmodemXXXX`
   - Windows: `COM3`, `COM5`, и т. п.
2. Запустите TUI-приложение:
   - По умолчанию (порт и скорость можно указать в UI):
     ```bash
     python utils/radar-tui.py
     ```
   - С явным указанием порта и скорости (пример):
     ```bash
     python utils/radar-tui.py /dev/ttyUSB0 115200
     ```
3. Подключитесь к радару (если не подключилось автоматически).
4. Нажмите кнопку «Trigger Firmware update» в правой панели.
   - Внутри это посылает служебный кадр (тип 0x3000), переводящий устройство в режим загрузчика.
   - После этого радар перестанет отвечать как обычное приложение и будет ожидать загрузку файла по XMODEM‑CRC.
5. Закройте `radar-tui.py` (Ctrl+Q или кнопкой выхода), чтобы освободить последовательный порт.

## Шаг 2. Загрузить прошивку через XMODEM‑CRC
Передача файла выполняется скриптом `utils/xmodem_send.py`. Получатель (загрузчик радара) инициирует XMODEM‑CRC — он будет периодически отправлять символ `C`. Отправка начнётся, как только скрипт увидит этот символ.

Примеры запуска:

- Linux/macOS:
  ```bash
  python utils/xmodem_send.py --port /dev/ttyUSB0 --baud 115200 --file utils/firmware.bin
  ```
  Замените путь к порту и имя файла на ваши.

- Windows:
  ```bash
  python utils/xmodem_send.py --port COM5 --baud 115200 --file utils/firmware.bin
  ```

Полезные опции `xmodem_send.py`:
- `--initial-timeout` — сколько секунд ждать запрос CRC (`C`) от загрузчика (по умолчанию 30).
- `--per-try-timeout` — таймаут ожидания ACK/NAK на каждый блок (по умолчанию 10).
- `--retries` — максимум повторов отправки для одного блока (по умолчанию 10).
- `--rtscts` — включить аппаратное управление потоком.
- `--xonxoff` — включить программное управление потоком.
- `--no-progress` — отключить печать прогресса.

Пример с увеличенным начальными таймаутом:
```bash
python utils/xmodem_send.py --port /dev/ttyUSB0 --baud 115200 --file utils/hlk-ld6002-3D.bin --initial-timeout 60
```

## Проверка результата
- По завершении передачи скрипт сообщит об успешной отправке всех блоков.
- Обычно устройство перезапускается автоматически. При необходимости отключите/включите питание радара.
- Повторно запустите `radar-tui.py` и убедитесь, что устройство отвечает и сообщает версию новой прошивки.

## Частые проблемы и их решение
- Скрипт `xmodem_send.py` «висит» на ожидании символа `C`:
  - Убедитесь, что вы действительно перевели радар в режим загрузчика (повторите Шаг 1 и закройте TUI).
  - Проверьте правильность выбранного порта и скорость UART.
  - Попробуйте увеличить `--initial-timeout`.
- Ошибки передачи (много NAK/повторов):
  - Проверьте качество кабеля и соединения.
  - При необходимости включите `--rtscts` или `--xonxoff` в зависимости от вашего адаптера.
- Порт занят/недоступен:
  - Убедитесь, что `radar-tui.py` закрыт и никакая другая программа не держит порт открытым.

## Примечания
- Команда перевода в режим обновления прошивки: тип кадра `0x3000` (см. `utils/radar-tui.py`, кнопка «Trigger Firmware update»). Также документировано в `docs/undocumented-commands-hlk-ld6002.md`.
- Отправка файла идёт блоками по 128 байт с CP/M‑padding (0x1A) в последнем блоке. Режим — XMODEM‑CRC.
- Список прошивок можно найти здесь: [firmware-list-hlk-ld6002.md](firmware-list-hlk-ld6002.md)
